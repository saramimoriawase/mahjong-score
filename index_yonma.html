<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <title>å››äººéº»é›€ çµæœå…¥åŠ›ï¼‹é£›ã³ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ï¼ˆæœ€çµ‚çµæœã®ã¿å±¥æ­´ãƒ»ç´¯è¨ˆLINEå…±æœ‰ãƒ»è¤‡æ•°é£›ã³å¯¾å¿œï¼‰</title>
  <style>
    :root{
      --bg-table:#0b6b3f;
      --bg-table-light:#14532d;
      --bg-card:#fefcf5;
      --accent:#b91c1c;
      --accent-dark:#7f1d1d;
      --text-main:#0f172a;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,
        'Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;
      background:radial-gradient(circle at top, #0f9d58 0, var(--bg-table) 40%, #053222 100%);
      color:var(--text-main);
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{
      max-width:780px;
      margin:0 auto;
      padding:10px 10px 18px;
      box-sizing:border-box;
    }
    .table-frame{
      border-radius:18px;
      padding:10px;
      background:linear-gradient(135deg,var(--bg-table-light),#064e3b);
      box-shadow:0 0 0 3px #022c22, 0 10px 25px rgba(0,0,0,0.4);
    }
    .header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:8px;
      color:#fefce8;
      gap:6px;
      flex-wrap:wrap;
    }
    .header-title{
      font-size:17px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tile-mark{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:26px;height:26px;
      border-radius:6px;
      background:#fef9c3;
      border:2px solid var(--accent);
      font-weight:800;
      color:var(--accent);
      box-shadow:0 2px 0 var(--accent);
      flex-shrink:0;
    }
    .header-sub{
      font-size:11px;
      opacity:0.9;
      line-height:1.4;
      max-width:260px;
    }
    .card{
      background:var(--bg-card);
      border-radius:14px;
      padding:10px;
      box-shadow:0 3px 0 #cbd5e1;
      margin-bottom:10px;
      border:1px solid #e2e8f0;
    }
    .card-settings{
      padding:6px 8px;
      margin-bottom:8px;
      box-shadow:0 2px 0 #cbd5e1;
    }

    /* è¨­å®š */
    .settings-grid{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:4px;
      font-size:11px;
    }
    .settings-item label{
      display:block;
      margin-bottom:2px;
    }
    .settings-item input{
      width:100%;
      padding:5px 8px;
      font-size:12px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      box-sizing:border-box;
      background:#f9fafb;
    }
    .settings-item input:focus{
      outline:none;
      border-color:#16a34a;
      box-shadow:0 0 0 1px #16a34a33;
      background:#fff;
    }
    .settings-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:4px;
    }
    .settings-actions button{
      padding:6px 12px;
      font-size:12px;
      min-height:0;
    }
    .settings-toggle-bar{
      display:flex;
      justify-content:flex-start;
      margin-bottom:6px;
    }
    .settings-toggle-btn{
      background:#e5e7eb;
      color:#111827;
      box-shadow:none;
      padding:6px 12px;
      font-size:12px;
      min-height:0;
      border-radius:999px;
      border:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    /* åˆè¨ˆè¡¨ç¤º */
    .totalScores{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:6px;
      margin-bottom:8px;
      font-size:14px;
      font-weight:700;
      color:#fefce8;
    }
    @media (min-width:560px){
      .totalScores{grid-template-columns:repeat(4,1fr);}
    }
    .player-total{
      padding:8px 10px;
      border-radius:12px;
      background:linear-gradient(90deg,#166534,#15803d);
      box-shadow:0 2px 0 #052e16;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .player-total span.label{
      font-size:11px;
      font-weight:500;
      opacity:0.9;
    }

    .player-total #totalE,
    .player-total #totalS,
    .player-total #totalW,
    .player-total #totalN{
      font-size:15px;
      font-weight:700;
    }
    .rank-line{
      font-size:11px;
      margin-top:2px;
      opacity:0.95;
    }

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .grid4{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    @media (min-width:720px){
      .grid4{
        display:grid;
        grid-template-columns:repeat(4,1fr);
      }
    }
    .player-box-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
      font-size:13px;
    }
    .wind-tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;height:22px;
      border-radius:999px;
      background:#fee2e2;
      border:1px solid var(--accent);
      font-size:11px;
      font-weight:700;
      color:var(--accent);
    }
    input[type=number], input[type=text]{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      box-sizing:border-box;
      font-size:14px;
      background:#f9fafb;
    }
    input[type=number]:focus, input[type=text]:focus{
      outline:none;
      border-color:#16a34a;
      box-shadow:0 0 0 1px #16a34a33;
      background:#ffffff;
    }
    .score-label{
      font-size:11px;
      text-align:left;
      color:#4b5563;
      margin:4px 0 3px;
    }
    .tobi-flags{
      margin-top:4px;
      font-size:11px;
      color:#374151;
      display:flex;
      flex-direction:row;
      flex-wrap:wrap;
      gap:4px 10px;
    }
    .tobi-flags label{
      display:flex;
      align-items:center;
      gap:3px;
    }
    .tobi-flags input[type=checkbox]{
      width:16px;
      height:16px;
    }

    /* ã‚³ãƒ¡ãƒ³ãƒˆï¼†ãƒœã‚¿ãƒ³ */
    .comment-input{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#f9fafb;
      font-size:13px;
      box-sizing:border-box;
    }
    .comment-input:focus{
      outline:none;
      border-color:#16a34a;
      box-shadow:0 0 0 1px #16a34a33;
      background:#fff;
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    @media (min-width:520px){
      .controls{
        flex-direction:row;
        flex-wrap:wrap;
      }
    }
    button{
      background:var(--accent);
      color:#fff;
      padding:10px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
      box-shadow:0 3px 0 var(--accent-dark);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      min-height:40px;
    }
    button.secondary{
      background:#4b5563;
      box-shadow:0 3px 0 #111827;
    }
    button:active{
      transform:translateY(1px);
      box-shadow:0 1px 0 rgba(0,0,0,0.4);
    }

    /* å±¥æ­´ */
    .history{
      max-height:320px;
      overflow:auto;
      padding:6px;
      background:#f9fafb;
      border-radius:10px;
      border:1px solid #e2e8f0;
      font-size:12px;
      -webkit-overflow-scrolling:touch;
    }
    .row{
      padding:8px;
      border-radius:8px;
      background:#fefce8;
      margin-bottom:8px;
      border:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .row-main{
      flex:1;
    }
    .row-title{
      font-weight:700;
      font-size:13px;
      margin-bottom:3px;
    }
    .row-line{
      margin-top:2px;
      line-height:1.4;
    }
    .row-comment{
      font-size:11px;
      color:#4b5563;
      margin-top:3px;
    }
    .row-buttons{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex-shrink:0;
    }
    .row-buttons button{
      padding:4px 10px;
      font-size:11px;
      box-shadow:none;
      background:#e5e7eb;
      color:#111827;
      min-height:0;
    }
    .row-buttons button:hover{
      background:#d4d4d8;
    }
    @media (max-width:420px){
      .row{
        flex-direction:column;
      }
      .row-buttons{
        flex-direction:row;
        justify-content:flex-end;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="table-frame">
    <div class="header">
      <div class="header-title">
        <span class="tile-mark">æ±</span>
        <span>å››äººéº»é›€ çµæœï¼‹é£›ã³ã‚¹ã‚³ã‚¢ï¼ˆæœ€çµ‚çµæœå±¥æ­´ãƒ»ç´¯è¨ˆLINEå…±æœ‰ãƒ»è¤‡æ•°é£›ã³å¯¾å¿œï¼‰</span>
      </div>
      <div class="header-sub">
        åŠè˜ã”ã¨ã®ã€Œçµæœãƒã‚¤ãƒ³ãƒˆã€ã ã‘å…¥åŠ›ã€‚é£›ã³è¾¼ã¿å¾ŒãŒãã®åŠè˜ã®æœ€çµ‚çµæœã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚<br>
        1äººãŒè¤‡æ•°äººã‚’åŒæ™‚ã«é£›ã°ã—ãŸå ´åˆã€é£›ã°ã—ãŸäººæ•°åˆ†ã ã‘ãƒœãƒ¼ãƒŠã‚¹ãŒåŠ ç®—ã•ã‚Œã¾ã™ã€‚
      </div>
    </div>

    <!-- è¨­å®šãƒˆã‚°ãƒ« -->
    <div class="settings-toggle-bar">
      <button id="toggleSettingsBtn" class="settings-toggle-btn">é£›ã³è¨­å®š â–¼</button>
    </div>

    <!-- è¨­å®šã‚¨ãƒªã‚¢ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
    <div class="card card-settings" id="settingsPanel" style="display:none;">
      <div class="settings-grid">
        <div class="settings-item">
          <label>é£›ã°ã—ãŸãƒœãƒ¼ãƒŠã‚¹ï¼ˆ1äººé£›ã°ã™ã”ã¨ï¼‰</label>
          <input type="number" id="tobiWinInput" value="10" />
        </div>
        <div class="settings-item">
          <label>é£›ã°ã•ã‚ŒãŸãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆ1äººã¶ã‚“ï¼‰</label>
          <input type="number" id="tobiLoseInput" value="-10" />
        </div>
        <div class="settings-item">
          <label style="margin-bottom:0;">æ³¨æ„</label>
          <span style="font-size:10px;color:#6b7280;">çµæœ4äººã®åˆè¨ˆã¯0ã«ã—ã¦ãã ã•ã„ï¼ˆé£›ã³ã¯è‡ªå‹•åŠ ç®—ï¼è¤‡æ•°é£›ã³æ™‚ã¯äººæ•°åˆ†åŠ ç®—ï¼‰</span>
        </div>
      </div>
      <div class="settings-actions">
        <button id="applySettingsBtn">è¨­å®šã‚’é©ç”¨</button>
      </div>
    </div>

    <!-- åˆè¨ˆè¡¨ç¤º -->
    <div class="totalScores">
      <div class="player-total">
        <span class="label">ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆï¼ˆæœ€çµ‚çµæœãƒ™ãƒ¼ã‚¹ï¼‰</span>
        <div id="totalE">æ±: 0</div>
        <div class="rank-line" id="rankE">é †ä½: 1ä½0å› / 2ä½0å› / 3ä½0å› / 4ä½0å›</div>
      </div>
      <div class="player-total">
        <span class="label">&nbsp;</span>
        <div id="totalS">å—: 0</div>
        <div class="rank-line" id="rankS">é †ä½: 1ä½0å› / 2ä½0å› / 3ä½0å› / 4ä½0å›</div>
      </div>
      <div class="player-total">
        <span class="label">&nbsp;</span>
        <div id="totalW">è¥¿: 0</div>
        <div class="rank-line" id="rankW">é †ä½: 1ä½0å› / 2ä½0å› / 3ä½0å› / 4ä½0å›</div>
      </div>
      <div class="player-total">
        <span class="label">&nbsp;</span>
        <div id="totalN">åŒ—: 0</div>
        <div class="rank-line" id="rankN">é †ä½: 1ä½0å› / 2ä½0å› / 3ä½0å› / 4ä½0å›</div>
      </div>
    </div>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="card">
      <div class="grid4">
        <div>
          <div class="player-box-title">
            <span><span class="wind-tag">æ±</span></span>
          </div>
          <input type="text" id="nameE" placeholder="æ±ã®åå‰" value="æ±" />
          <div class="score-label">ã“ã®åŠè˜ã®çµæœï¼ˆãƒã‚¤ãƒ³ãƒˆï¼š+/-ï¼‰</div>
          <input type="number" id="resE" inputmode="numeric" placeholder="ä¾‹: 25" />
          <div class="tobi-flags">
            <label><input type="checkbox" id="tobiWinE" /> é£›ã°ã—ãŸ</label>
            <label><input type="checkbox" id="tobiLoseE" /> é£›ã°ã•ã‚ŒãŸ</label>
          </div>
        </div>

        <div>
          <div class="player-box-title">
            <span><span class="wind-tag">å—</span></span>
          </div>
          <input type="text" id="nameS" placeholder="å—ã®åå‰" value="å—" />
          <div class="score-label">ã“ã®åŠè˜ã®çµæœï¼ˆãƒã‚¤ãƒ³ãƒˆï¼š+/-ï¼‰</div>
          <input type="number" id="resS" inputmode="numeric" placeholder="ä¾‹: -5" />
          <div class="tobi-flags">
            <label><input type="checkbox" id="tobiWinS" /> é£›ã°ã—ãŸ</label>
            <label><input type="checkbox" id="tobiLoseS" /> é£›ã°ã•ã‚ŒãŸ</label>
          </div>
        </div>

        <div>
          <div class="player-box-title">
            <span><span class="wind-tag">è¥¿</span></span>
          </div>
          <input type="text" id="nameW" placeholder="è¥¿ã®åå‰" value="è¥¿" />
          <div class="score-label">ã“ã®åŠè˜ã®çµæœï¼ˆãƒã‚¤ãƒ³ãƒˆï¼š+/-ï¼‰</div>
          <input type="number" id="resW" inputmode="numeric" placeholder="ä¾‹: -10" />
          <div class="tobi-flags">
            <label><input type="checkbox" id="tobiWinW" /> é£›ã°ã—ãŸ</label>
            <label><input type="checkbox" id="tobiLoseW" /> é£›ã°ã•ã‚ŒãŸ</label>
          </div>
        </div>

        <div>
          <div class="player-box-title">
            <span><span class="wind-tag">åŒ—</span></span>
          </div>
          <input type="text" id="nameN" placeholder="åŒ—ã®åå‰" value="åŒ—" />
          <div class="score-label">ã“ã®åŠè˜ã®çµæœï¼ˆãƒã‚¤ãƒ³ãƒˆï¼š+/-ï¼‰</div>
          <input type="number" id="resN" inputmode="numeric" placeholder="ä¾‹: -10" />
          <div class="tobi-flags">
            <label><input type="checkbox" id="tobiWinN" /> é£›ã°ã—ãŸ</label>
            <label><input type="checkbox" id="tobiLoseN" /> é£›ã°ã•ã‚ŒãŸ</label>
          </div>
        </div>
      </div>

      <div style="margin-top:10px">
        <input
          type="text"
          id="comment"
          class="comment-input"
          placeholder="ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¾‹ï¼šç®±ä¸‹ãƒ»è¦ªå€ãƒ„ãƒ¢ãƒ»ãƒˆãƒªãƒ—ãƒ«é£›ã³ãªã©ï¼‰"
        />
      </div>

      <div class="controls">
        <button id="calcBtn">ğŸ€„ è¨ˆç®—ã—ã¦è¨˜éŒ²</button>
        <button id="resetBtn" class="secondary">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="shareLineBtn" class="secondary">LINEã§å…±æœ‰ï¼ˆç´¯è¨ˆã®ã¿ï¼‰</button>
        <button id="downloadCsv" class="secondary">CSVå‡ºåŠ›</button>
        <input type="file" id="uploadCsv" accept=".csv,text/csv" style="display:none;">
        <button id="uploadCsvBtn" class="secondary">CSVèª­ã¿è¾¼ã¿</button>
      </div>

    </div>

    <!-- å±¥æ­´ -->
    <div class="card">
      <h3 style="margin:0 0 6px;font-size:14px;">å±¥æ­´ï¼ˆæœ€çµ‚çµæœã®ã¿ãƒ»è¤‡æ•°é£›ã³å¯¾å¿œï¼‰</h3>
      <div class="history" id="historyList"></div>
    </div>
  </div>
</div>

<script>
// è¨­å®šãƒˆã‚°ãƒ«
document.getElementById("toggleSettingsBtn").addEventListener("click", function(){
  var p = document.getElementById("settingsPanel");
  var isHidden = p.style.display === "none" || p.style.display === "";
  p.style.display = isHidden ? "block" : "none";
  this.textContent = isHidden ? "é£›ã³è¨­å®š â–²" : "é£›ã³è¨­å®š â–¼";
});

// è¨­å®šï¼ˆé£›ã³ã®ã¿å¯å¤‰ï¼‰
let settings = {
  tobiWin: 10,
  tobiLose: -10
};

// history: {res:{E,S,W,N}, pts:{E,S,W,N}, names, comment, tobi}
let history = [];
let editingIndex = null;

function computeTotals(){
  const total = {E:0,S:0,W:0,N:0};
  history.forEach(function(h){
    total.E += h.pts.E;
    total.S += h.pts.S;
    total.W += h.pts.W;
    total.N += h.pts.N;
  });
  return total;
}

function fmtSigned(n){
  if(n > 0) return "+" + n;
  return "" + n;
}

function describeTobi(tobi, names){
  var parts = [];
  ["E","S","W","N"].forEach(function(w){
    var flag = tobi[w];
    if(!flag) return;
    if(flag.win){
      parts.push(names[w] + " é£›ã°ã—");
    }
    if(flag.lose){
      parts.push(names[w] + " é£›ã°ã•ã‚ŒãŸ");
    }
  });
  if(parts.length === 0) return "";
  return parts.join(" / ");
}

function updateDOM(){
  const totals = computeTotals();

  const nameE = document.getElementById("nameE").value || "æ±";
  const nameS = document.getElementById("nameS").value || "å—";
  const nameW = document.getElementById("nameW").value || "è¥¿";
  const nameN = document.getElementById("nameN").value || "åŒ—";

  document.getElementById("totalE").textContent = nameE + ": " + totals.E;
  document.getElementById("totalS").textContent = nameS + ": " + totals.S;
  document.getElementById("totalW").textContent = nameW + ": " + totals.W;
  document.getElementById("totalN").textContent = nameN + ": " + totals.N;

  // ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆã®è‰²åˆ†ã‘
  ["E","S","W","N"].forEach(function(w){
    const el = document.getElementById("total"+w);
    if(!el) return;
    const v = totals[w];
    if(v > 0) el.style.color = "#007bff";
    else if(v < 0) el.style.color = "#ff3333";
    else el.style.color = "#000000";
  });

  // ç´¯è¨ˆé †ä½ã‚«ã‚¦ãƒ³ãƒˆï¼ˆå››éº»ï¼‰
  const rankCounts = {
    E: {1:0,2:0,3:0,4:0},
    S: {1:0,2:0,3:0,4:0},
    W: {1:0,2:0,3:0,4:0},
    N: {1:0,2:0,3:0,4:0}
  };
  history.forEach(function(h){
    const arr = [
      {w:"E", v:h.pts.E},
      {w:"S", v:h.pts.S},
      {w:"W", v:h.pts.W},
      {w:"N", v:h.pts.N}
    ];
    arr.sort(function(a,b){ return b.v - a.v; });
    let prevVal = null;
    let currentRank = 1;
    arr.forEach(function(item, idx){
      if(prevVal !== null && item.v < prevVal){
        currentRank = idx + 1;
      }
      rankCounts[item.w][currentRank] += 1;
      prevVal = item.v;
    });
  });
  if(document.getElementById("rankE")){
    const rc = rankCounts.E;
    document.getElementById("rankE").textContent =
      "é †ä½: 1ä½" + (rc[1]||0) + "å› / 2ä½" + (rc[2]||0) + "å› / 3ä½" + (rc[3]||0) + "å› / 4ä½" + (rc[4]||0) + "å›";
  }
  if(document.getElementById("rankS")){
    const rc = rankCounts.S;
    document.getElementById("rankS").textContent =
      "é †ä½: 1ä½" + (rc[1]||0) + "å› / 2ä½" + (rc[2]||0) + "å› / 3ä½" + (rc[3]||0) + "å› / 4ä½" + (rc[4]||0) + "å›";
  }
  if(document.getElementById("rankW")){
    const rc = rankCounts.W;
    document.getElementById("rankW").textContent =
      "é †ä½: 1ä½" + (rc[1]||0) + "å› / 2ä½" + (rc[2]||0) + "å› / 3ä½" + (rc[3]||0) + "å› / 4ä½" + (rc[4]||0) + "å›";
  }
  if(document.getElementById("rankN")){
    const rc = rankCounts.N;
    document.getElementById("rankN").textContent =
      "é †ä½: 1ä½" + (rc[1]||0) + "å› / 2ä½" + (rc[2]||0) + "å› / 3ä½" + (rc[3]||0) + "å› / 4ä½" + (rc[4]||0) + "å›";
  }

  const historyList = document.getElementById("historyList");
  historyList.innerHTML = "";

  history.forEach(function(h, idx){
    const no = idx + 1;
    const div = document.createElement("div");
    div.className = "row";

    const lineFinal =
      h.names.E + " " + fmtSigned(h.pts.E) + " / " +
      h.names.S + " " + fmtSigned(h.pts.S) + " / " +
      h.names.W + " " + fmtSigned(h.pts.W) + " / " +
      h.names.N + " " + fmtSigned(h.pts.N);

    const tobiText = describeTobi(h.tobi, h.names);

    const main = document.createElement("div");
    main.className = "row-main";
    let html =
      '<div class="row-title">ç¬¬ ' + no + ' åŠè˜</div>' +
      '<div class="row-line">[æœ€çµ‚çµæœ] ' + lineFinal + '</div>';
    if(tobiText){
      html += '<div class="row-line">[é£›ã³] ' + tobiText + '</div>';
    }
    if(h.comment){
      html += '<div class="row-comment">â€» ' + h.comment + '</div>';
    }
    main.innerHTML = html;

    const btns = document.createElement("div");
    btns.className = "row-buttons";

    const editBtn = document.createElement("button");
    editBtn.textContent = "ç·¨é›†";
    editBtn.onclick = function(){ startEdit(idx); };

    const delBtn = document.createElement("button");
    delBtn.textContent = "å‰Šé™¤";
    delBtn.onclick = function(){ deleteHand(idx); };

    btns.appendChild(editBtn);
    btns.appendChild(delBtn);

    div.appendChild(main);
    div.appendChild(btns);
    historyList.appendChild(div);
  });

  document.getElementById("calcBtn").textContent =
    editingIndex === null ? "ğŸ€„ è¨ˆç®—ã—ã¦è¨˜éŒ²" : "âœ” ä¿®æ­£ã‚’åæ˜ ";
}

function clearInputArea(){
  document.getElementById("resE").value = "";
  document.getElementById("resS").value = "";
  document.getElementById("resW").value = "";
  document.getElementById("resN").value = "";
  document.getElementById("comment").value = "";
  document.getElementById("tobiWinE").checked = false;
  document.getElementById("tobiLoseE").checked = false;
  document.getElementById("tobiWinS").checked = false;
  document.getElementById("tobiLoseS").checked = false;
  document.getElementById("tobiWinW").checked = false;
  document.getElementById("tobiLoseW").checked = false;
  document.getElementById("tobiWinN").checked = false;
  document.getElementById("tobiLoseN").checked = false;
}

// è¨­å®šãƒœã‚¿ãƒ³
document.getElementById("applySettingsBtn").addEventListener("click", function(){
  const tWin = Number(document.getElementById("tobiWinInput").value) || 0;
  const tLose = Number(document.getElementById("tobiLoseInput").value) || 0;
  settings.tobiWin = tWin;
  settings.tobiLose = tLose;
  alert("è¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ");
});

// è¨ˆç®—ã—ã¦è¨˜éŒ² / ä¿®æ­£åæ˜ 
document.getElementById("calcBtn").addEventListener("click", function(){
  const res = {
    E: Number(document.getElementById("resE").value) || 0,
    S: Number(document.getElementById("resS").value) || 0,
    W: Number(document.getElementById("resW").value) || 0,
    N: Number(document.getElementById("resN").value) || 0
  };

  const names = {
    E: document.getElementById("nameE").value || "æ±",
    S: document.getElementById("nameS").value || "å—",
    W: document.getElementById("nameW").value || "è¥¿",
    N: document.getElementById("nameN").value || "åŒ—"
  };

  if(res.E === 0 && res.S === 0 && res.W === 0 && res.N === 0){
    alert("ã“ã®åŠè˜ã®çµæœãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const sum = res.E + res.S + res.W + res.N;
  if(sum !== 0){
    alert("çµæœã®åˆè¨ˆãŒ0ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚é£›ã³ãƒã‚¤ãƒ³ãƒˆã¯è‡ªå‹•ã§åŠ ç®—ã•ã‚Œã‚‹ã®ã§ã€çµæœéƒ¨åˆ†ã ã‘ã§åˆè¨ˆ0ã«ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  const tobi = {
    E: {
      win:  document.getElementById("tobiWinE").checked,
      lose: document.getElementById("tobiLoseE").checked
    },
    S: {
      win:  document.getElementById("tobiWinS").checked,
      lose: document.getElementById("tobiLoseS").checked
    },
    W: {
      win:  document.getElementById("tobiWinW").checked,
      lose: document.getElementById("tobiLoseW").checked
    },
    N: {
      win:  document.getElementById("tobiWinN").checked,
      lose: document.getElementById("tobiLoseN").checked
    }
  };

  // é£›ã³è¾¼ã¿å¾Œãƒã‚¤ãƒ³ãƒˆï¼ˆ= æœ€çµ‚çµæœï¼‰
  const pts = {E:res.E, S:res.S, W:res.W, N:res.N};

  // ã€Œé£›ã°ã•ã‚ŒãŸã€äººæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ1äººãŒè¤‡æ•°äººåŒæ™‚ã«é£›ã°ã—ãŸå ´åˆãªã©ã«å¯¾å¿œï¼‰
  const losers = ["E","S","W","N"].filter(function(w){ return tobi[w].lose; });
  const losersCount = losers.length;

  ["E","S","W","N"].forEach(function(w){
    var flag = tobi[w];
    if(!flag) return;
    // é£›ã°ã—ãŸäººã«ã¯ã€Œé£›ã°ã—ãŸäººæ•° Ã— ãƒœãƒ¼ãƒŠã‚¹ã€ã‚’åŠ ç®—
    if(flag.win && losersCount > 0){
      pts[w] += settings.tobiWin * losersCount;
    }
    // é£›ã°ã•ã‚ŒãŸäººã«ã¯1äººåˆ†ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ãã‚Œãã‚ŒåŠ ç®—
    if(flag.lose){
      pts[w] += settings.tobiLose;
    }
  });

  const comment = document.getElementById("comment").value;
  const entry = { res: res, pts: pts, names: names, comment: comment, tobi: tobi };

  if(editingIndex === null){
    history.push(entry);
  }else{
    history[editingIndex] = entry;
    editingIndex = null;
  }

  clearInputArea();
  updateDOM();
});

// ç·¨é›†é–‹å§‹
function startEdit(index){
  const h = history[index];
  editingIndex = index;

  document.getElementById("resE").value = h.res.E;
  document.getElementById("resS").value = h.res.S;
  document.getElementById("resW").value = h.res.W;
  document.getElementById("resN").value = h.res.N;
  document.getElementById("comment").value = h.comment || "";

  document.getElementById("tobiWinE").checked = !!h.tobi.E.win;
  document.getElementById("tobiLoseE").checked = !!h.tobi.E.lose;
  document.getElementById("tobiWinS").checked = !!h.tobi.S.win;
  document.getElementById("tobiLoseS").checked = !!h.tobi.S.lose;
  document.getElementById("tobiWinW").checked = !!h.tobi.W.win;
  document.getElementById("tobiLoseW").checked = !!h.tobi.W.lose;
  document.getElementById("tobiWinN").checked = !!h.tobi.N.win;
  document.getElementById("tobiLoseN").checked = !!h.tobi.N.lose;

  updateDOM();
}

// å‰Šé™¤
function deleteHand(index){
  if(!confirm("ã“ã®åŠè˜ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  history.splice(index,1);
  editingIndex = null;
  updateDOM();
}

// å…¨ãƒªã‚»ãƒƒãƒˆ
document.getElementById("resetBtn").addEventListener("click", function(){
  if(!confirm("å…¨ã¦ã®å±¥æ­´ã¨åˆè¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  history = [];
  editingIndex = null;
  clearInputArea();
  updateDOM();
});

// CSVå‡ºåŠ›ï¼ˆæœ€çµ‚çµæœãƒ™ãƒ¼ã‚¹ï¼‰
document.getElementById("downloadCsv").addEventListener("click", function(){
  let csv = "åŠè˜,æ±æœ€çµ‚çµæœ,å—æœ€çµ‚çµæœ,è¥¿æœ€çµ‚çµæœ,åŒ—æœ€çµ‚çµæœ,æ±é£›ã°ã—,æ±è¢«é£›ã°ã—,å—é£›ã°ã—,å—è¢«é£›ã°ã—,è¥¿é£›ã°ã—,è¥¿è¢«é£›ã°ã—,åŒ—é£›ã°ã—,åŒ—è¢«é£›ã°ã—,ã‚³ãƒ¡ãƒ³ãƒˆ\n";
  history.forEach(function(h,i){
    const safeComment = (h.comment || "").replace(/,/g," ");
    csv +=
      (i+1) + "," +
      h.pts.E + "," + h.pts.S + "," + h.pts.W + "," + h.pts.N + "," +
      (h.tobi.E.win ? 1 : 0) + "," + (h.tobi.E.lose ? 1 : 0) + "," +
      (h.tobi.S.win ? 1 : 0) + "," + (h.tobi.S.lose ? 1 : 0) + "," +
      (h.tobi.W.win ? 1 : 0) + "," + (h.tobi.W.lose ? 1 : 0) + "," +
      (h.tobi.N.win ? 1 : 0) + "," + (h.tobi.N.lose ? 1 : 0) + "," +
      safeComment + "\n";
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "yonma_result_tobi_final_history_multitobi.csv";
  a.click();
  URL.revokeObjectURL(url);
});


// CSVèª­ã¿è¾¼ã¿ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒï¼šæœ€çµ‚çµæœãƒ™ãƒ¼ã‚¹ï¼‰
document.getElementById("uploadCsvBtn").addEventListener("click", function(){
  document.getElementById("uploadCsv").click();
});

document.getElementById("uploadCsv").addEventListener("change", function(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      importCsvYonma(ev.target.result);
      alert("CSVã‹ã‚‰å±¥æ­´ã‚’å¾©å…ƒã—ã¾ã—ãŸã€‚");
    }catch(err){
      console.error(err);
      alert("CSVã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };
  reader.readAsText(file);
  e.target.value = "";
});

function importCsvYonma(text){
  const lines = text.trim().split(/\r?\n/);
  if(lines.length <= 1){
    alert("ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const header = lines[0].split(",");
  if(header.length < 14){
    throw new Error("ãƒ˜ãƒƒãƒ€åˆ—æ•°ãŒæƒ³å®šã‚ˆã‚Šå°‘ãªã„ã§ã™ã€‚");
  }

  const names = {
    E: document.getElementById("nameE").value || "æ±",
    S: document.getElementById("nameS").value || "å—",
    W: document.getElementById("nameW").value || "è¥¿",
    N: document.getElementById("nameN").value || "åŒ—"
  };

  history = [];
  editingIndex = null;

  for(let i = 1; i < lines.length; i++){
    const line = lines[i].trim();
    if(!line) continue;

    const cols = line.split(",");
    if(cols.length < 14) continue;

    const pts = {
      E: Number(cols[1]) || 0,
      S: Number(cols[2]) || 0,
      W: Number(cols[3]) || 0,
      N: Number(cols[4]) || 0
    };

    const tobi = {
      E: { win: cols[5] === "1",  lose: cols[6] === "1"  },
      S: { win: cols[7] === "1",  lose: cols[8] === "1"  },
      W: { win: cols[9] === "1",  lose: cols[10] === "1" },
      N: { win: cols[11] === "1", lose: cols[12] === "1" }
    };

    const comment = cols.slice(13).join(",");

    const res = {E: pts.E, S: pts.S, W: pts.W, N: pts.N};

    history.push({
      res: res,
      pts: pts,
      names: { ...names },
      comment: comment,
      tobi: tobi
    });
  }

  updateDOM();
}

// LINEå…±æœ‰ï¼ˆç´¯è¨ˆã®ã¿ï¼‰
document.getElementById("shareLineBtn").addEventListener("click", async function(){
  if(history.length === 0){
    alert("ã¾ãšã¯1åŠè˜ä»¥ä¸Šã®çµæœã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  const totals = computeTotals();
  const nameE2 = document.getElementById("nameE").value || "æ±";
  const nameS2 = document.getElementById("nameS").value || "å—";
  const nameW2 = document.getElementById("nameW").value || "è¥¿";
  const nameN2 = document.getElementById("nameN").value || "åŒ—";

  // ç´¯è¨ˆé †ä½ã‚«ã‚¦ãƒ³ãƒˆï¼ˆLINEå…±æœ‰ç”¨ï¼šå››éº»ï¼‰
  const rankCounts = {
    E: {1:0,2:0,3:0,4:0},
    S: {1:0,2:0,3:0,4:0},
    W: {1:0,2:0,3:0,4:0},
    N: {1:0,2:0,3:0,4:0}
  };
  history.forEach(function(h){
    const arr = [
      {w:"E", v:h.pts.E},
      {w:"S", v:h.pts.S},
      {w:"W", v:h.pts.W},
      {w:"N", v:h.pts.N}
    ];
    arr.sort(function(a,b){ return b.v - a.v; });
    let prevVal = null;
    let currentRank = 1;
    arr.forEach(function(item, idx){
      if(prevVal !== null && item.v < prevVal){
        currentRank = idx + 1;
      }
      rankCounts[item.w][currentRank] += 1;
      prevVal = item.v;
    });
  });

  function formatRank(rc){
    return "1ä½" + (rc[1]||0) + "å›ã€2ä½" + (rc[2]||0) + "å›ã€3ä½" + (rc[3]||0) + "å›ã€4ä½" + (rc[4]||0) + "å›";
  }

  const lines = [];
  lines.push("ã€å››äººéº»é›€ ç´¯è¨ˆã‚¹ã‚³ã‚¢ã€‘");
  lines.push("åŠè˜æ•°: " + history.length);
  lines.push("");
  lines.push(nameE2 + " " + fmtSigned(totals.E));
  lines.push(nameS2 + " " + fmtSigned(totals.S));
  lines.push(nameW2 + " " + fmtSigned(totals.W));
  lines.push(nameN2 + " " + fmtSigned(totals.N));
  lines.push("");
  lines.push("ã€é †ä½å†…è¨³ã€‘");
  lines.push(nameE2 + " : " + formatRank(rankCounts.E));
  lines.push(nameS2 + " : " + formatRank(rankCounts.S));
  lines.push(nameW2 + " : " + formatRank(rankCounts.W));
  lines.push(nameN2 + " : " + formatRank(rankCounts.N));

  const text = lines.join("\n");

  if (navigator.share) {
    try{
      await navigator.share({ text });
      return;
    }catch(e){
      console.log(e);
    }
  }

  const encoded = encodeURIComponent(text);
  const url = "https://line.me/R/msg/text/?" + encoded;
  window.open(url, "_blank");
});

updateDOM();
</script>
</body>
</html>
